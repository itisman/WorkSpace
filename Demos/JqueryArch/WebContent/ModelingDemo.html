<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Modeling Demo</title>

<style>
	/* Prevent the text contents of draggable elements from being selectable. */
	[draggable] {
	  -moz-user-select: none;
	  -khtml-user-select: none;
	  -webkit-user-select: none;
	  user-select: none;
	  /* Required to make elements draggable in old WebKit */
	  -khtml-user-drag: element;
	  -webkit-user-drag: element;
	}
	.column {
	  height: 150px;
	  width: 150px;
	  position: absolute;
	  border: 2px solid #666666;
	  background-color: #ccc;
	  margin-right: 5px;
	  -webkit-border-radius: 10px;
	  -ms-border-radius: 10px;
	  -moz-border-radius: 10px;
	  border-radius: 10px;
	  -webkit-box-shadow: inset 0 0 3px #000;
	  -ms-box-shadow: inset 0 0 3px #000;
	  box-shadow: inset 0 0 3px #000;
	  text-align: center;
	  cursor: move;
	}
	.column header {
	  color: #fff;
	  text-shadow: #000 0 1px;
	  box-shadow: 5px;
	  padding: 5px;
	  background: -moz-linear-gradient(left center, rgb(0,0,0), rgb(79,79,79), rgb(21,21,21));
	  background: -webkit-gradient(linear, left top, right top,
	                               color-stop(0, rgb(0,0,0)),
	                               color-stop(0.50, rgb(79,79,79)),
	                               color-stop(1, rgb(21,21,21)));
	  background: -webkit-linear-gradient(left center, rgb(0,0,0), rgb(79,79,79), rgb(21,21,21));
	  background: -ms-linear-gradient(left center, rgb(0,0,0), rgb(79,79,79), rgb(21,21,21));
	  border-bottom: 1px solid #ddd;
	  -webkit-border-top-left-radius: 10px;
	  -moz-border-radius-topleft: 10px;
	  -ms-border-radius-topleft: 10px;
	  border-top-left-radius: 10px;
	  -webkit-border-top-right-radius: 10px;
	  -ms-border-top-right-radius: 10px;
	  -moz-border-radius-topright: 10px;
	  border-top-right-radius: 10px;
	}
	.column.over {
		border: 2px dashed #000;
	}
	.line{
		background-color: black;
		left:2px;
		right:300px;
		height:10px;
		width:300px;
	}
	.status{
		float: right;
		height: 50px;
		width: 100px;		
	}
	
</style>
</head>
<body>
	<div id="x" class="status">X: </div>
	<div id="y" class="status">Y: </div>
	<div id="columns" style="height:1000px">
		<div id="line" class="line"></div>
		<div id="divA" class="column" style="left:10px; top:100px" draggable="true"><header>A</header></div>
		<div id="divB" class="column" style="left:210px; top:200px" draggable="true"><header>B</header></div>
		<div id="divC" class="column" style="left:510px; top:100px" draggable="true"><header>C</header></div>
	</div>
</body>
</html>
<script type="text/javascript" src="JS/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
	function handleDrop(e) {
		// this/e.target is current target element.
		if (e.stopPropagation) {
			e.stopPropagation(); // Stops some browsers from redirecting.
		}	
		
		// Don't do anything if dropping the same column we're dragging.
		if (dragSrcEl != this) {
			// Set the source column's HTML to the HTML of the column we dropped on.
			var offset = event.dataTransfer.getData("text/plain").split(',');

			dragSrcEl.style.left = (event.clientX + parseInt(offset[0],10)) + 'px';
			dragSrcEl.style.top = (event.clientY + parseInt(offset[1],10)) + 'px';
			dragSrcEl.style.opacity = '1';
			//this.innerHTML = e.dataTransfer.getData('text/html');
		}
	}
	
	function handleDragEnd(e) {
		// this/e.target is the source node.
		/*
		[].forEach.call(cols, function (col) {
			col.classList.remove('over');
		});
		*/
	}

	function handleDragStart(e) {
		// Target (this) element is the source node.
		this.style.opacity = '0.4';

		dragSrcEl = this;

		e.dataTransfer.effectAllowed = 'move';
		e.dataTransfer.setData('text/html', this.innerHTML);
		var style = window.getComputedStyle(event.target, null);
		event.dataTransfer.setData("text/plain", (parseInt(style.getPropertyValue("left"),10) - event.clientX) + ',' + (parseInt(style.getPropertyValue("top"),10) - event.clientY));
		
		
	}
	
	
	function handleDragOver(e) {
	  if (e.preventDefault) {
	    e.preventDefault(); // Necessary. Allows us to drop.
	  }
	
	  e.dataTransfer.dropEffect = 'move';  // See the section on the DataTransfer object.
	
	  return false;
	}
	
	function handleDragEnter(e) {
	  // this / e.target is the current hover target.
	  //this.classList.add('over');
	}
	
	function handleDragLeave(e) {
		// this / e.target is previous target element.
		//this.classList.remove('over');  
	}
	
	function handleDrag(e){
		var x = document.getElementById("x");
		var y = document.getElementById("y");
		x.innerText = 'X: ' + $("#divA").offset().left;
		y.innerText = 'Y: ' + event.clientY;
		
		
		var boxCenterXOffset = 75;
		var boxCenterYOffset = 75;
		//try connect line
		var x1 = $("#divB").offset().left + boxCenterXOffset;
        var x2 = $("#divC").offset().left + boxCenterXOffset;
        var y1 = $("#divB").offset().top + boxCenterYOffset;
        var y2 = $("#divC").offset().top + boxCenterYOffset;

        var hypotenuse = Math.sqrt((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2));
        var angle = Math.atan2((y1-y2), (x1-x2)) *  (180/Math.PI);
        if(angle >= 90 && angle < 180){
            y1 = y1 - (y1-y2);
        }
        if(angle > 0 && angle < 90){
            x1 = x1 - (x1-x2);
            y1 = y1 - (y1-y2);
        }
        if(angle <= 0 && angle > -90){
            x1 = x1 - (x1-x2);
        }
        
        $("#line").queue(function(){
            $(this).offset({top: y1, left: x1});
            $(this).dequeue();
        }).queue(function(){
            $(this).width(hypotenuse);
            $(this).dequeue();
        }).queue(function(){
            $(this).rotate(angle);
            $(this).dequeue();
        });
		
		
	}
	
	var dragSrcEl;
	var cols = document.querySelectorAll('#columns .column');
	[].forEach.call(cols, function(col) {
	  col.addEventListener('dragstart', handleDragStart);
	  col.addEventListener('dragenter', handleDragEnter);	  
	  col.addEventListener('dragleave', handleDragLeave);	  
	  col.addEventListener('dragend', handleDragEnd);
	  col.addEventListener('drag', handleDrag);
	});


	var columns = document.getElementById("columns");
	columns.addEventListener('dragover', handleDragOver);
	columns.addEventListener('drop', handleDrop);
</script>
